#!/usr/bin/env node

/**
 * Initialization System
 * REQ-003: NPM Package Foundation - Init Command
 *
 * This is a wrapper that provides the init command interface
 * expected by REQ-003 tests while delegating to the comprehensive
 * initialization system implemented in setup/init.js (1,557 lines).
 */

const path = require('path');

// PROJECT_TYPES - Exposed for test compatibility
const PROJECT_TYPES = {
  generic: {
    name: 'Generic Project',
    description: 'A general-purpose project with basic workflow support',
    defaultRules: ['general-patterns', 'git-workflows', 'testing-standards'],
    additionalRules: [],
    equipmentPacks: ['git-hooks', 'templates', 'documentation'],
    icon: 'üìã',
  },
  'web-frontend': {
    name: 'Web Frontend',
    description: 'Frontend web application (React, Vue, Angular, etc.)',
    defaultRules: ['general-patterns', 'web-frontend', 'component-patterns'],
    additionalRules: ['accessibility', 'performance-optimization'],
    equipmentPacks: ['git-hooks', 'templates', 'web-frontend-tools'],
    icon: 'üåê',
  },
  'node-backend': {
    name: 'Node.js Backend',
    description: 'Backend API or service built with Node.js',
    defaultRules: ['general-patterns', 'node-backend', 'api-design'],
    additionalRules: ['database-patterns', 'authentication'],
    equipmentPacks: ['git-hooks', 'templates', 'node-backend-tools'],
    icon: '‚ö°',
  },
  'full-stack': {
    name: 'Full Stack Application',
    description: 'Complete application with frontend and backend',
    defaultRules: [
      'general-patterns',
      'web-frontend',
      'node-backend',
      'full-stack',
    ],
    additionalRules: ['database-patterns', 'api-design', 'deployment'],
    equipmentPacks: ['git-hooks', 'templates', 'full-stack-tools'],
    icon: 'üöÄ',
  },
  'chrome-extension': {
    name: 'Chrome Extension',
    description: 'Browser extension for Chrome/Chromium',
    defaultRules: ['general-patterns', 'chrome-extension', 'web-frontend'],
    additionalRules: ['security-patterns', 'browser-apis'],
    equipmentPacks: ['git-hooks', 'templates', 'extension-tools'],
    icon: 'üîå',
  },
  'ai-agent': {
    name: 'AI Agent Project',
    description: 'AI agent or automation system',
    defaultRules: ['general-patterns', 'ai-patterns', 'testing-standards'],
    additionalRules: ['api-design', 'performance-optimization'],
    equipmentPacks: ['git-hooks', 'templates', 'ai-tools'],
    icon: 'ü§ñ',
  },
  library: {
    name: 'Library/Package',
    description: 'Reusable library or npm package',
    defaultRules: ['general-patterns', 'library-patterns', 'documentation'],
    additionalRules: ['testing-standards', 'performance-optimization'],
    equipmentPacks: ['git-hooks', 'templates', 'library-tools'],
    icon: 'üì¶',
  },
  monorepo: {
    name: 'Monorepo',
    description: 'Multi-package repository with shared tooling',
    defaultRules: [
      'general-patterns',
      'monorepo-patterns',
      'testing-standards',
    ],
    additionalRules: ['workspace-management', 'cross-package-dependencies'],
    equipmentPacks: ['git-hooks', 'templates', 'monorepo-tools'],
    icon: 'üèóÔ∏è',
  },
};

class InitManager {
  constructor() {
    this.initPath = path.join(__dirname, 'setup', 'init.js');
  }

  async execute(directory, options = {}) {
    try {
      // Import the new modular initialization system
      const { initCommand } = require('./setup/init/index');

      // Prepare options for the init system
      const initOptions = {
        directory: directory || process.cwd(),
        projectName: options.name || 'supernal-coding',
        alias: options.alias || 'sc',
        ...options,
      };

      // Execute initialization with new modular system
      await initCommand(initOptions);
    } catch (error) {
      console.error('‚ùå Initialization error:', error.message);
      throw error;
    }
  }

  // Show help text that matches REQ-003 test expectations
  showHelp() {
    console.log('Usage: sc init [options] [directory]');
    console.log('Equip current repository');
    console.log('');
    console.log('Arguments:');
    console.log('  directory        Target directory (default: current)');
    console.log('');
    console.log('Options:');
    console.log('  --name <n>       Project name (default: supernal-coding)');
    console.log('  --alias <alias>  Command alias (default: sc)');
    console.log('  --interactive    Interactive setup mode (default: true)');
    console.log(
      '  --dry-run        Show what would be installed without doing it'
    );
    console.log('  --yes            Skip confirmations and use defaults');
    console.log('  -h, --help       display help for command');
  }

  // Static method for direct execution (used by CLI)
  static async main(directory, options = {}) {
    const manager = new InitManager();

    // Handle help request
    if (options.help) {
      manager.showHelp();
      return;
    }

    await manager.execute(directory, options);
  }
}

// Export the command function directly
module.exports = async function (directory, options) {
  const manager = new InitManager();

  // Handle help request
  if (options && options.help) {
    manager.showHelp();
    return;
  }

  await manager.execute(directory, options);
};

// Export class and PROJECT_TYPES for direct use and test compatibility
module.exports.InitManager = InitManager;
module.exports.PROJECT_TYPES = PROJECT_TYPES;

// If run directly, execute with command line arguments
if (require.main === module) {
  const args = process.argv.slice(2);
  const options = {};
  let directory = null;

  // Parse basic command line arguments
  args.forEach((arg, index) => {
    if (arg === '--help' || arg === '-h') options.help = true;
    else if (arg === '--interactive') options.interactive = true;
    else if (arg === '--dry-run') options.dryRun = true;
    else if (arg === '--yes') options.yes = true;
    else if (arg.startsWith('--name=')) options.name = arg.split('=')[1];
    else if (arg.startsWith('--alias=')) options.alias = arg.split('=')[1];
    else if (arg === '--name' && args[index + 1])
      options.name = args[index + 1];
    else if (arg === '--alias' && args[index + 1])
      options.alias = args[index + 1];
    else if (
      !arg.startsWith('-') &&
      !directory &&
      args[index - 1] !== '--name' &&
      args[index - 1] !== '--alias'
    ) {
      directory = arg;
    }
  });

  InitManager.main(directory, options).catch((error) => {
    console.error('‚ùå Error:', error.message);
    process.exit(1);
  });
}
